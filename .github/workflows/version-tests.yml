name: Version tests

env:
  JAVA_VERSION: 25

on:
  schedule:
    - cron: '0 3 * * 1'  # Every Monday at 4 AM UTC
  workflow_dispatch:
    inputs:
      parallelism:
        description: The number of versions to verify in parallel
        required: false
        type: number
        default: '2'
      image:
        description: The docling-serve image to fetch
        required: true
        type: string
        default: docling-project/docling-serve
      registry:
        description: The registry to fetch the image from
        required: true
        type: string
        default: ghcr.io
      outputDir:
        description: The output directory to write the results to
        required: true
        type: string
        default: results
      tags:
        description: |
          The tags to test (comma separated).
          If blank, list of tags will be fetched dynamically
        required: false
        type: string
      excludeTagsRegex:
        description: A regex to exclude tags from testing. Tags matching this regex will be excluded.
        required: false
        type: string
        default: '^v0.*'
      createGithubIssue:
        description: Create a GitHub issue if any of the tests fail
        required: true
        type: boolean
        default: true

concurrency:
  group: "workflow = ${{ github.workflow }}, ref = ${{ github.event.ref }}, pr = ${{ github.event.pull_request.id }}"
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

defaults:
  run:
    shell: bash

permissions:
  actions: read
  contents: write
  issues: write
  pull-requests: write

jobs:
  versions-tests:
    runs-on: ubuntu-latest
    if: github.repository == 'docling-project/docling-java'
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.DOCLING_JAVA_CI_APP_ID }}
          private-key: ${{ secrets.DOCLING_JAVA_CI_PRIVATE_KEY }}
          permission-actions: read
          permission-contents: write
          permission-issues: write
          permission-pull-requests: write

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          persist-credentials: false

      - name: Reclaim disk space
        working-directory: .github/scripts
        shell: bash
        run: ./ci-reclaim-disk-space.sh

      - name: Process tags and flags
        run: |
          INPUT="${{ inputs.tags }}"
          TAGS=${INPUT:+$(echo "$INPUT" | tr -d ' ' | sed 's/,/ -t /g' | sed 's/^/-t /')}
          echo "TAGS=$TAGS" >> $GITHUB_ENV
      
          CREATE_GITHUB_ISSUE_FLAG="--create-github-issue"
          if [ "${{ inputs.createGithubIssue }}" == "false" ]; then
            CREATE_GITHUB_ISSUE_FLAG="--no-create-github-issue"
          fi
      
          echo "CREATE_GITHUB_ISSUE_FLAG=$CREATE_GITHUB_ISSUE_FLAG" >> $GITHUB_ENV
          
          # Set defaults for scheduled runs
          echo "PARALLELISM=${{ inputs.parallelism || '2' }}" >> $GITHUB_ENV
          echo "IMAGE=${{ inputs.image || 'docling-project/docling-serve' }}" >> $GITHUB_ENV
          echo "REGISTRY=${{ inputs.registry || 'ghcr.io' }}" >> $GITHUB_ENV
          echo "OUTPUT_DIR=${{ inputs.outputDir || 'results' }}" >> $GITHUB_ENV
          echo "EXCLUDE_TAGS_REGEX=${{ inputs.excludeTagsRegex || '^v0.*' }}" >> $GITHUB_ENV

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0

      - name: Build version tester
        run: ./gradlew --no-daemon -Pjava.version=${{ env.JAVA_VERSION }} :docling-version-tests:build

      - name: Run version tester
        working-directory: docling-testing/docling-version-tests
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          java -jar build/quarkus-app/quarkus-run.jar \
            -p ${{ env.PARALLELISM }} \
            -i ${{ env.IMAGE }} \
            -r ${{ env.REGISTRY }} \
            -o ${{ env.OUTPUT_DIR }} \
            -e ${{ env.EXCLUDE_TAGS_REGEX }} \
            --cleanup-container-images \
            ${{ env.TAGS }} ${{ env.CREATE_GITHUB_ISSUE_FLAG }}

      - name: Copy output markdown to docs
        run: find docling-testing/docling-version-tests/${{ env.OUTPUT_DIR }} -name 'results.md' -exec cp -r '{}' docs/src/doc/docs/includes/docling-serve/serve-compatibility.md ';'

      - name: Create docs PR
        id: create-pr
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          add-paths: docs/src/doc/docs/includes/docling-serve/serve-compatibility.md
          commit-message: "docs: Update docling-serve compatibility table (from ${{ github.workflow }} run # ${{ github.run_number }})"
          branch: update-serve-compatibility/sourceref
          branch-suffix: short-commit-hash
          delete-branch: true
          base: main
          signoff: true
          sign-commits: true
          title: "docs: Update docling-serve compatibility table (from ${{ github.workflow }} run # ${{ github.run_number }})"
          body: "docs: Update docling-serve compatibility table from [${{ github.workflow }} run # ${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}), which was triggered by commit ${{ env.REF }}."
          labels: |
            automation
            documentation
            area:docling-serve

      - name: Merge PR
        if: (steps.create-pr.outputs.pull-request-operation == 'created') && steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: gh pr merge --merge --admin --delete-branch "${{ steps.create-pr.outputs.pull-request-url }}"
